{% extends 'base.html' %}
{% block title %}{{ group.name }} - LEARN HUB{% endblock %}

{% block content %}
<div class="container my-5">

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0"><i class="bi bi-people-fill"></i> {{ group.name }}</h3>
                    <div>
                        {% if not is_member %}
                        <a href="{% url 'join_group' group.pk %}" class="btn btn-light">
                            <i class="bi bi-person-plus"></i> Join Group
                        </a>
                        {% else %}
                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> Member</span>
                        {% if user != group.created_by %}
                        <a href="{% url 'leave_group' group.pk %}" class="btn btn-outline-light btn-sm">Leave</a>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>

                <div class="card-body">
                    <p class="mb-2"><strong><i class="bi bi-tag"></i> Subject:</strong> {{ group.subject }}</p>
                    <p class="mb-2"><strong><i class="bi bi-person"></i> Created by:</strong> {{ group.created_by.username }}</p>
                    <p class="mb-2"><strong><i class="bi bi-people"></i> Members:</strong> {{ group.members.count }}/{{ group.max_members }}</p>
                    <p class="mb-0"><strong><i class="bi bi-info-circle"></i> Description:</strong></p>
                    <p>{{ group.description }}</p>
                </div>
            </div>
        </div>
    </div>

    {% if is_member %}
    <!-- NAV TABS -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#chat"><i class="bi bi-chat-dots"></i> Chat</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#resources"><i class="bi bi-file-earmark-text"></i> Resources</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#calendar"><i class="bi bi-calendar-event"></i> Calendar</a>
        </li>
    </ul>

    <div class="tab-content">

        <!-- CHAT TAB -->
        <div id="chat" class="tab-pane fade show active">
            <div class="row">

                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">Group Chat</div>

                        <div class="card-body">
                            <div class="chat-container" id="chatContainer">
                                {% for msg in messages %}
                                <div class="message-bubble {% if msg.sender == user %}own-message{% endif %}" data-sent-at="{{ msg.sent_at|date:'c' }}">
                                    <strong>{{ msg.sender.username }}</strong>
                                    <p class="mb-1">{{ msg.content }}</p>
                                    <small class="text-muted">{{ msg.sent_at|date:"g:i A" }}</small>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- CHAT INPUT -->
                            <form id="messageForm" class="mt-3">
                                {% csrf_token %}
                                <div class="input-group">
                                    <input type="text" class="form-control" id="messageInput" placeholder="Type your message..." required>
                                    <button class="btn btn-primary" type="submit">
                                        <i class="bi bi-send"></i> Send
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- MEMBERS PANEL -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">Members ({{ group.members.count }})</div>
                        <div class="card-body">
                            {% for member in group.members.all %}
                            <div class="d-flex align-items-center mb-3">
                                <div class="member-avatar me-2">{{ member.username|first|upper }}</div>
                                <div>
                                    <strong>{{ member.username }}</strong>
                                    {% if member == group.created_by %}
                                    <span class="badge bg-warning text-dark">Admin</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- RESOURCES TAB -->
        <div id="resources" class="tab-pane fade">
            <div class="row">

                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">Shared Resources</div>
                        <div class="card-body">

                            {% for resource in resources %}
                            <div class="resource-item">
                                <h5>
                                    <i class="bi bi-{{ resource.resource_type }}"></i> {{ resource.title }}
                                    <span class="badge bg-secondary">{{ resource.get_resource_type_display }}</span>
                                </h5>

                                <p class="mb-1">{{ resource.description }}</p>

                                {% if resource.file %}
                                <a href="{{ resource.file.url }}" download class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> Download</a>
                                {% endif %}

                                {% if resource.link %}
                                <a href="{{ resource.link }}" target="_blank" class="btn btn-outline-primary btn-sm"><i class="bi bi-link-45deg"></i> Open Link</a>
                                {% endif %}

                                <small class="text-muted d-block mt-2">Shared by {{ resource.uploaded_by.username }} on {{ resource.uploaded_at|date:"M d, Y" }}</small>
                            </div>
                            {% empty %}
                            <p class="text-muted">No resources shared yet.</p>
                            {% endfor %}

                        </div>
                    </div>
                </div>

                <!-- ADD RESOURCE -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">Add Resource</div>
                        <div class="card-body">
                            <form method="post" action="{% url 'add_resource' group.pk %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                {{ resource_form.as_p }}
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-plus-circle"></i> Add Resource
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- CALENDAR TAB -->
        <div id="calendar" class="tab-pane fade">
            <div class="row">

                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">Upcoming Study Sessions</div>
                        <div class="card-body">
                            {% for session in upcoming_sessions %}
                            <div class="calendar-event">
                                <h5><i class="bi bi-calendar-check"></i> {{ session.title }}</h5>
                                <p class="mb-1">{{ session.description }}</p>
                                <p><strong>Date & Time:</strong> {{ session.scheduled_time|date:"M d, Y g:i A" }}</p>
                                <p><strong>Duration:</strong> {{ session.duration_minutes }} minutes</p>
                                <small class="text-muted">Scheduled by {{ session.created_by.username }}</small>
                            </div>
                            {% empty %}
                            <p class="text-muted">No sessions scheduled.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- ADD SESSION -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">Schedule Session</div>
                        <div class="card-body">
                            <form method="post" action="{% url 'add_session' group.pk %}">
                                {% csrf_token %}
                                {{ session_form.as_p }}
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-calendar-plus"></i> Schedule
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    {% else %}
    <div class="alert alert-info"><i class="bi bi-info-circle"></i> Join to access chat and resources.</div>
    {% endif %}

</div>
{% endblock %}


{% block extra_js %}
{% if is_member %}
<script>
$(document).ready(function () {

    /* -------------------------
       Bootstrap Auto-close Alert
    ---------------------------*/
    function showAlert(message, type = "success") {
        const alert = $(`
            <div class="alert alert-${type} alert-dismissible fade show custom-alert" role="alert">
                ${message}
            </div>
        `);

        $("body").append(alert);

        setTimeout(() => {
            alert.alert("close");
        }, 3000);
    }

    const chatContainer = $("#chatContainer");
    const messageInput = $("#messageInput");
    const messageForm = $("#messageForm");
    const groupPk = {{ group.pk }};
    const csrfToken = "{{ csrf_token }}";
    const currentUsername = "{{ user.username }}";

    function scrollChatToBottom() {
        chatContainer.scrollTop(chatContainer[0].scrollHeight);
    }
    scrollChatToBottom();

    function createMessageHtml(msg) {
        const isOwn = msg.sender === currentUsername;
        const cls = isOwn ? "own-message" : "";
        return `
            <div class="message-bubble ${cls}" data-sent-at="${msg.sent_at_iso}">
                <strong>${msg.sender}</strong>
                <p class="mb-1">${msg.content}</p>
                <small class="text-muted">${msg.sent_at_display}</small>
            </div>
        `;
    }

    /* -------------------------
       SEND MESSAGE
    ---------------------------*/
    messageForm.on("submit", function (e) {
        e.preventDefault();
        const content = messageInput.val().trim();
        if (!content) return;

        $.post(`/group/${groupPk}/message/send/`, {
            content: content,
            csrfmiddlewaretoken: csrfToken
        }, function (response) {
            if (response.success) {
                const msg = response.message;
                chatContainer.append(createMessageHtml(msg));
                messageInput.val("");
                scrollChatToBottom();

                showAlert("Message sent!");
            }
        });
    });


    /* -------------------------
       FETCH NEW MESSAGES
    ---------------------------*/
    function fetchNewMessages() {
        const lastMsg = chatContainer.children(".message-bubble:last");
        let lastTime = lastMsg.length ? lastMsg.data("sent-at") : "";

        $.get(`/group/${groupPk}/messages/`, {
            last_message_time: lastTime
        }, function (response) {

            if (response.messages && response.messages.length > 0) {

                let atBottom = chatContainer[0].scrollHeight - chatContainer.scrollTop() <= chatContainer.outerHeight();

                response.messages.forEach(msg => {

                    chatContainer.append(createMessageHtml(msg));

                    if (msg.sender !== currentUsername) {
                        showAlert(`New message from ${msg.sender}`, "info");
                    }

                });

                if (atBottom) scrollChatToBottom();
            }

        });
    }

    setInterval(fetchNewMessages, 5000);

});
</script>
{% endif %}
{% endblock %}
